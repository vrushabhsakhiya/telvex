{% extends 'base.html' %}

{% block content %}
<div class="page-header"
    style="margin-bottom: 2rem; display: flex; justify-content: space-between; align-items: center;">
    <h2 style="font-size: 1.5rem; font-weight: 600;">{{ t('bills_and_payments') }}</h2>
    <div style="display: flex; gap: 1rem; align-items: center;">
        <div class="month-nav"
            style="display: flex; align-items: center; background: var(--card-bg); padding: 0.25rem; border-radius: 0.375rem; border: 1px solid var(--border-color);">
            <a href="{{ month_nav.prev_url }}" class="btn btn-sm btn-ghost" title="Previous Month"
                style="color: var(--text-secondary);">
                <i class="fa-solid fa-chevron-left"></i>
            </a>
            <span
                style="padding: 0 1rem; font-weight: 600; color: var(--text-primary); min-width: 140px; text-align: center;">
                {{ month_nav.current }}
            </span>
            <a href="{{ month_nav.next_url }}" class="btn btn-sm btn-ghost" title="Next Month"
                style="color: var(--text-secondary);">
                <i class="fa-solid fa-chevron-right"></i>
            </a>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="card" style="margin-bottom: 1.5rem;">
    <form action="{{ url_for('bills') }}" method="GET" class="filter-bar"
        style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">

        <!-- Search -->
        <div style="flex: 1; min-width: 200px; position: relative;">
            <i class="fa-solid fa-magnifying-glass"
                style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-secondary);"></i>
            <input type="text" name="q" value="{{ request.args.get('q', '') }}"
                placeholder="{{ t('search_name_mobile') }}"
                style="width: 100%; padding: 0.75rem 0.75rem 0.75rem 2.5rem; border: 1px solid var(--border-color); border-radius: 0.375rem; background: var(--bg-color); color: var(--text-primary);">
        </div>

        <!-- Gender Filter -->
        <select name="gender" onchange="this.form.submit()"
            style="padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.375rem; background: var(--bg-color); color: var(--text-primary); cursor: pointer;">
            <option value="">{{ t('all_genders') }}</option>
            <option value="male" {% if request.args.get('gender')=='male' %}selected{% endif %}>{{ t('male') }}</option>
            <option value="female" {% if request.args.get('gender')=='female' %}selected{% endif %}>{{ t('female') }}
            </option>
        </select>

        <!-- Balance/Status Filter -->
        <select name="status" onchange="this.form.submit()"
            style="padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.375rem; background: var(--bg-color); color: var(--text-primary); cursor: pointer;">
            <option value="">{{ t('balance_all') }}</option>
            <option value="pending" {% if request.args.get('status')=='pending' %}selected{% endif %}>{{
                t('pending_balance') }}
            </option>
            <option value="paid" {% if request.args.get('status')=='paid' %}selected{% endif %}>{{ t('all_paid') }}
            </option>
        </select>

        <!-- Reset Button -->
        {% if request.args.get('q') or request.args.get('gender') or request.args.get('status') %}
        <a href="{{ url_for('bills') }}" class="btn btn-outline"
            style="border: 1px solid var(--border-color); padding: 0.75rem;">
            <i class="fa-solid fa-xmark"></i>
        </a>
        {% endif %}
    </form>
</div>

<div class="card">
    <div class="table-container">
        <table id="billsTable">
            <thead>
                <tr>
                    <th>{{ t('bill_id') }}</th>
                    <th>{{ t('date') }}</th>
                    <th>{{ t('customer') }}</th>
                    <th>{{ t('items') }}</th>
                    <th>{{ t('total_bill') }}</th>
                    <th>{{ t('advance_payment') }}</th>
                    <th>{{ t('pending_payment') }}</th>
                    <th>{{ t('payment_status') }}</th>
                    <th>{{ t('action') }}</th>
                </tr>
            </thead>
            <tbody>
                {% for bill in bills %}
                <tr class="bill-row" data-status="{{ bill.payment_status }}">
                    <td>{{ bill.id }}</td>
                    <td>{{ bill.created_at.strftime('%Y-%m-%d') }}</td>
                    <td>
                        <div style="font-weight: 600;">{{ bill.customer.name }}</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">{{ bill.customer.mobile }}</div>
                    </td>
                    <td>
                        {% for item in bill.items %}
                        <span class="badge badge-secondary" style="font-size: 0.75rem;">{{ item.name }}</span>
                        {% endfor %}
                    </td>
                    <td style="font-weight: 600;">₹{{ bill.total_amt }}</td>
                    <td style="color: var(--success-color);">₹{{ bill.advance }}</td>
                    <td style="color: var(--danger-color);">₹{{ bill.balance }}</td>
                    <td>
                        <div style="display: flex; flex-direction: column; align-items: flex-start; gap: 4px;">
                            {% if bill.payment_status == 'Paid' %}
                            <span class="badge badge-primary" style=" color: #047857; padding: 4px 8px;">Paid</span>
                            {% elif bill.payment_status == 'Half-Payment' %}
                            <span class="badge badge-secondary"
                                style=" color: #D97706; padding: 4px 8px;">Half-Payment</span>
                            {% else %}
                            <span class="badge badge-secondary"
                                style=" color: #B91C1C; padding: 4px 8px;">Pending</span>
                            {% endif %}

                            {% if bill.payment_mode %}
                            <div
                                style="font-size: 0.75rem; color: var(--text-secondary); display: flex; align-items: center; gap: 4px;">
                                <i class="fa-solid fa-wallet" style="font-size: 0.7rem;"></i> {{ bill.payment_mode }}
                            </div>
                            {% endif %}
                        </div>
                    </td>
                    <td>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <a href="{{ url_for('view_invoice', id=bill.id) }}" target="_blank"
                                class="btn btn-sm btn-outline"
                                style="border: 1px solid var(--border-color); color: var(--text-secondary); width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center; border-radius: 6px;"
                                title="Print Invoice">
                                <i class="fa-solid fa-print"></i>
                            </a>
                            <button class="btn btn-sm btn-primary"
                                onclick="openPaymentModal('{{ bill.id }}', '{{ bill.total_amt }}', '{{ bill.advance }}', '{{ bill.payment_status }}', '{{ bill.payment_mode }}', '{{ bill.start_date.strftime('%Y-%m-%d') if bill.start_date else 'None' }}', '{{ bill.delivery_date.strftime('%Y-%m-%d') if bill.delivery_date else 'None' }}', 'System')"
                                style="font-size: 0.75rem; padding: 0.4rem 0.8rem; height: 32px; display: inline-flex; align-items: center; gap: 0.4rem;"
                                title="Update Payment">
                                <i class="fa-solid fa-pen-to-square"></i> Manage
                            </button>
                            </button>

                            <form action="{{ url_for('delete_order', id=bill.id) }}" method="POST"
                                onsubmit="return confirm('Are you sure you want to delete this bill? This action cannot be undone.');">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                                <button type="submit" class="btn btn-sm"
                                    style="background-color: #fee2e2; color: #ef4444; width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center; border-radius: 6px;"
                                    title="Delete Bill">
                                    <i class="fa-solid fa-trash-can"></i>
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="9" style="text-align: center; padding: 2rem;">{{ t('no_bills_found') }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div
        style="display: flex; justify-content: space-between; align-items: center; padding-top: 1rem; border-top: 1px solid var(--border-color);">
        <div style="font-size: 0.875rem; color: var(--text-secondary); display: flex; align-items: center; gap: 1rem;">
            <span>{{ t('showing_page') }} {{ pagination.page }} of {{ pagination.pages }}</span>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <span style="font-size: 0.8rem;">{{ t('go_to') }}:</span>
                <input type="number" min="1" max="{{ pagination.pages }}" value="{{ pagination.page }}"
                    class="form-input"
                    style="width: 70px; padding: 0.25rem 0.5rem; border: 1px solid var(--border-color); border-radius: 4px;"
                    onchange="window.location.href='{{ url_for('bills') }}?page=' + this.value + '&q={{ request.args.get('q', '') }}&gender={{ request.args.get('gender', '') }}&status={{ request.args.get('status', '') }}&month={{ request.args.get('month', '') }}&year={{ request.args.get('year', '') }}'">
            </div>
        </div>

        <div style="display: flex; gap: 0.5rem;">
            {% if pagination.has_prev %}
            <a href="{{ url_for('bills', page=pagination.prev_num, q=request.args.get('q'), gender=request.args.get('gender'), status=request.args.get('status'), month=request.args.get('month'), year=request.args.get('year')) }}"
                class="btn btn-sm btn-outline" style="border: 1px solid var(--border-color); text-decoration: none;">
                <i class="fa-solid fa-chevron-left"></i> {{ t('prev') }}
            </a>
            {% else %}
            <button class="btn btn-sm btn-outline" disabled
                style="border: 1px solid var(--border-color); opacity: 0.5; cursor: not-allowed;">
                <i class="fa-solid fa-chevron-left"></i> {{ t('prev') }}
            </button>
            {% endif %}

            {% if pagination.has_next %}
            <a href="{{ url_for('bills', page=pagination.next_num, q=request.args.get('q'), gender=request.args.get('gender'), status=request.args.get('status'), month=request.args.get('month'), year=request.args.get('year')) }}"
                class="btn btn-sm btn-outline" style="border: 1px solid var(--border-color); text-decoration: none;">
                {{ t('next') }} <i class="fa-solid fa-chevron-right"></i>
            </a>
            {% else %}
            <button class="btn btn-sm btn-outline" disabled
                style="border: 1px solid var(--border-color); opacity: 0.5; cursor: not-allowed;">
                {{ t('next') }} <i class="fa-solid fa-chevron-right"></i>
            </button>
            {% endif %}
        </div>
    </div>
</div>

<!-- Payment Update Modal -->
<div id="paymentModal" class="sidebar-overlay" onclick="toggleModal('paymentModal')">
    <div class="sidebar-panel" onclick="event.stopPropagation()">
        <div
            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem;">
            <h3 style="font-size: 1.5rem; font-weight: 600;">Update Payment</h3>
            <button onclick="toggleModal('paymentModal')"
                style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
        </div>

        <form method="POST" action="{{ url_for('bills_update') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            <input type="hidden" name="order_id" id="pay_order_id">

            <!-- Extra Details -->
            <div style="margin-bottom: 2rem; border-bottom: 1px dashed var(--border-color); padding-bottom: 1rem;">
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Payment Accepted By</label>
                    <input type="text" id="pay_created_by" class="form-input" readonly
                        style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.375rem; background: #f9fafb; color: var(--text-secondary); cursor: not-allowed;">
                </div>
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Start Date</label>
                    <input type="date" id="pay_start_date" class="form-input" readonly
                        style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.375rem; background: #f9fafb; color: var(--text-secondary); cursor: not-allowed;">
                </div>
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Delivery / Finish
                        Date</label>
                    <input type="date" name="delivery_date" id="pay_delivery_date" class="form-input"
                        style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.375rem; background: var(--bg-color); color: var(--text-primary);">
                </div>
            </div>

            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Total Bill Amount (₹)</label>
                <input type="number" name="total_amt" id="pay_total" class="form-input" required
                    style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.375rem; background: var(--bg-color); color: var(--text-primary);">
            </div>

            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Amount Received / Advance
                    (₹)</label>
                <input type="number" name="advance" id="pay_advance" class="form-input" required
                    style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.375rem; background: var(--bg-color); color: var(--text-primary);">
            </div>

            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Payment Status</label>
                <select name="status" id="pay_status" class="form-input" required
                    style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.375rem; background: var(--bg-color); color: var(--text-primary);">
                    <option value="Pending">Pending</option>
                    <option value="Partial">Half-Payment</option>
                    <option value="Paid">Full Paid</option>
                </select>
            </div>

            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Payment Mode</label>
                <select name="payment_mode" id="pay_mode" class="form-input"
                    style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.375rem; background: var(--bg-color); color: var(--text-primary);">
                    <option value="">Select Mode</option>
                    <option value="Cash">Cash</option>
                    <option value="UPI">UPI</option>
                    <option value="Card">Card</option>
                </select>
            </div>

            <button type="submit" class="btn btn-primary" style="width: 100%;">Update Bill</button>
        </form>
    </div>
</div>

<style>
    /* Reuse Sidebar Styles from other pages if not global, assuming global reuse or copied here */
    .sidebar-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        justify-content: flex-end;
    }

    .sidebar-panel {
        width: 100%;
        max-width: 450px;
        height: 100%;
        background: var(--card-bg);
        padding: 2rem;
        box-shadow: -4px 0 15px rgba(0, 0, 0, 0.1);
        transform: translateX(100%);
        transition: transform 0.3s ease-out;
        overflow-y: auto;
    }

    .sidebar-overlay.active .sidebar-panel {
        transform: translateX(0);
    }
</style>

{% endblock %}