{% extends 'base.html' %}

{% block content %}
<div class="page-header" style="margin-bottom: 2rem;">
    <a href="{{ url_for('customers') }}"
        style="text-decoration: none; color: var(--text-secondary); margin-bottom: 0.5rem; display: inline-block;">
        <i class="fa-solid fa-arrow-left"></i> Back to Customers
    </a>
    <h2 style="font-size: 1.5rem; font-weight: 600;">Add Measurement for {{ customer.name }}</h2>
</div>

<div class="card" style="max-width: 800px; margin: 0 auto; min-height: 500px;">

    <!-- Step 1: Selection -->
    <div id="step1" class="step-container" {% if reuse_measurement %}style="display: none;" {% endif %}>
        <h3 style="margin-bottom: 1.5rem; text-align: center;">Select Category ({{ customer.gender|capitalize }})</h3>

        <!-- Categories (Dynamic) -->
        <div class="category-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
            {% for cat in categories %}
            <button class="cat-btn" onclick="selectCategoryFromData(this)" data-id="{{ cat.id }}"
                data-name="{{ cat.name }}" data-fields='{{ cat.fields_json|tojson }}'>
                {{ cat.name }}
            </button>
            {% else %}
            <p>No categories found for this gender. Please add them in settings.</p>
            {% endfor %}
        </div>
    </div>

    <!-- Step 2: Form -->
    <div id="step2" class="step-container {% if reuse_measurement %}d-block{% else %}d-none{% endif %}">
        <div
            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem;">
            <h3 id="formTitle">
                {% if reuse_measurement %}
                Reuse Measurement
                {% else %}
                Measurements
                {% endif %}
            </h3>
            {% if not reuse_measurement %}
            <button class="btn btn-sm btn-outline" onclick="goToStep(1)">Change Category</button>
            {% endif %}
        </div>

        <form method="POST" id="measurementForm" onsubmit="prepareSubmission(event)">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            <input type="hidden" name="category_id" id="input_category_id"
                value="{{ reuse_measurement.category_id if reuse_measurement else '' }}">
            <input type="hidden" name="measurements_json" id="input_measurements_json"
                value='{{ reuse_measurement.measurements_json|tojson if reuse_measurement else "" }}'>

            <!-- Dynamic Fields Container -->
            <div id="dynamicFields" class="fields-grid {% if reuse_measurement %}d-none{% endif %}"
                style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
                <!-- Fields injected by JS -->
            </div>

            <!-- Reuse Summary (Non-Editable) -->
            {% if reuse_measurement %}
            <div
                style="background: var(--bg-color); padding: 1rem; border-radius: 8px; border: 1px solid var(--border-color); margin-bottom: 2rem;">
                <h5 style="margin-bottom: 0.5rem; font-weight: 600;">Reusing Measurements: <span
                        class="badge badge-primary">{{ reuse_measurement.category.name }}</span></h5>
                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                    {% for k, v in reuse_measurement.measurements_json.items() %}
                    <span class="badge badge-secondary"
                        style="background: #e2e8f0; color: #334155; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem;">
                        {{ k }}: <strong>{{ v }}</strong>
                    </span>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Add Custom Field Button -->
            <div style="margin-bottom: 2rem; text-align: right;" class="{% if reuse_measurement %}d-none{% endif %}">
                <button type="button" class="btn btn-sm btn-outline" onclick="addCustomField()"
                    style="border: 1px dotted var(--primary-color); color: var(--primary-color);">
                    <i class="fa-solid fa-plus"></i> Add Extra Field
                </button>
            </div>

            <div class="form-group" style="margin-bottom: 2rem;">
                <label>Remarks / Special Note</label>
                <textarea name="remarks" class="form-control" rows="3"></textarea>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <!-- Unified Save Action -->
                <button type="button" class="btn btn-primary" onclick="saveAndOrder()"
                    style="width: 100%; justify-content: center; font-size: 1.1rem;">
                    <i class="fa-solid fa-check-circle"></i> Save & Create Order
                </button>
            </div>
        </form>
    </div>

</div>

<style>
    .cat-btn {
        padding: 1.5rem;
        background: var(--bg-color);
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        color: var(--text-primary);
        font-size: 1.1rem;
    }

    .cat-btn:hover {
        background: var(--secondary-color);
        color: white;
        border-color: var(--secondary-color);
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: var(--text-secondary);
    }

    .form-control {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 0.375rem;
        background: var(--bg-color);
        color: var(--text-primary);
        font-size: 1rem;
    }
</style>

<script>
    function selectCategoryFromData(btn) {
        const id = btn.dataset.id;
        const name = btn.dataset.name;
        const fields = JSON.parse(btn.dataset.fields);
        selectCategory(id, name, fields);
    }

    function selectCategory(id, name, fields) {
        // Go to step 2
        document.getElementById('step1').classList.add('d-none');

        const step2 = document.getElementById('step2');
        step2.classList.remove('d-none');
        step2.classList.add('d-block');

        document.getElementById('formTitle').innerText = name + ' Measurements';

        // Set basic inputs
        document.getElementById('input_category_id').value = id;

        // Render Fields
        const container = document.getElementById('dynamicFields');
        container.innerHTML = '';

        fields.forEach(field => {
            const div = document.createElement('div');
            div.className = 'form-group';
            div.innerHTML = `
                <label>${field} <span style="color:red">*</span></label>
                <input type="number" step="any" class="form-control measurement-input" data-field="${field}" 
                       oninput="this.value = this.value.replace(/[^0-9.]/g, '')" placeholder="0.00" required>
            `;
            container.appendChild(div);
        });
    }

    function goToStep(step) {
        if (step === 1) {
            const step2 = document.getElementById('step2');
            step2.classList.remove('d-block');
            step2.classList.add('d-none');

            document.getElementById('step1').classList.remove('d-none');
        }
    }

    function prepareSubmission(e) {
        // Gather all measurement inputs into JSON
        const inputs = document.querySelectorAll('.measurement-input');
        const data = {};
        inputs.forEach(input => {
            data[input.dataset.field] = input.value;
        });
        document.getElementById('input_measurements_json').value = JSON.stringify(data);
        return true;
    }

    function addCustomField() {
        const name = prompt("Enter Custom Field Name (e.g., 'Bicep'):");
        if (name && name.trim() !== "") {
            const container = document.getElementById('dynamicFields');
            const div = document.createElement('div');
            div.className = 'form-group';
            div.innerHTML = `
                <label>${name} <span style="color:red">*</span> <i class="fa-solid fa-xmark" style="font-size: 0.8em; color: red; cursor: pointer;" onclick="this.parentElement.parentElement.remove()"></i></label>
                <input type="number" step="any" class="form-control measurement-input" data-field="${name}" 
                       oninput="this.value = this.value.replace(/[^0-9.]/g, '')" placeholder="0.00" required>
            `;
            container.appendChild(div);
        }
    }

    // Trigger Save & Order
    function saveAndOrder() {
        // Validate all measurement inputs
        const inputs = document.querySelectorAll('.measurement-input');
        let isValid = true;

        inputs.forEach(input => {
            if (!input.value.trim()) {
                input.style.borderColor = 'red';
                isValid = false;
            } else {
                input.style.borderColor = ''; // Reset if valid
            }
        });

        if (!isValid) {
            alert('Please fill all compulsory measurement fields (marked with *).');
            return;
        }

        // Open Modal to get Order Details
        toggleOrderModal();
    }

    function submitOrder() {
        const form = document.getElementById('measurementForm');

        // Add hidden inputs for Order Details
        const fields = ['start_date', 'delivery_date', 'order_status', 'order_notes', 'total_amt', 'advance', 'payment_mode'];
        fields.forEach(f => {
            const val = document.getElementById('modal_' + f).value;
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = f;
            input.value = val;
            form.appendChild(input);
        });

        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'save_and_order';
        input.value = 'true';
        form.appendChild(input);

        prepareSubmission(null);

        // Disable Button
        const btn = document.querySelector('#orderModal .btn-primary');
        if (btn) {
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processing...';
        }

        form.submit();
    }

    // Check for Reuse ID on Load
    document.addEventListener('DOMContentLoaded', function () {
        const params = new URLSearchParams(window.location.search);
        const reuseId = params.get('reuse_id');

        if (reuseId) {
            fetch('/api/measurement/' + reuseId)
                .then(res => res.json())
                .then(data => {
                    if (data && data.category_id) {
                        // Find the category button to simulate click (or call selectCategory directly if we have name/fields)
                        // Since we passed fields_json to selectCategory, we need to find that data.
                        // Ideally we would have raw category data available.
                        // Hacky but works: find the button with onclick containing the ID.
                        // Better: Fetch category details or iterate buttons.

                        // We need the fields info. Let's look for the button with data-id (add data-id to buttons first? No, existing onclick has it)
                        // Let's iterate the category buttons.
                        const buttons = document.querySelectorAll('.cat-btn');
                        buttons.forEach(btn => {
                            // onclick="selectCategory(1, ...)"
                            // Parse the ID from attribute or add a logic to simplify
                            if (btn.getAttribute('onclick').includes(`selectCategory(${data.category_id},`)) {
                                btn.click(); // This will switch step and render fields

                                // Now fill values
                                setTimeout(() => { // Small delay to allow DOM update
                                    const inputs = document.querySelectorAll('.measurement-input');
                                    // data.data is the JSON object of measurements
                                    if (data.data) {
                                        inputs.forEach(inp => {
                                            const field = inp.dataset.field;
                                            if (data.data[field]) {
                                                inp.value = data.data[field];
                                            }
                                        });

                                        // Also add Custom Fields if they exist in data but not in form
                                        for (const [key, val] of Object.entries(data.data)) {
                                            // Check if input exists
                                            if (!document.querySelector(`.measurement-input[data-field="${key}"]`)) {
                                                // Add custom field
                                                const container = document.getElementById('dynamicFields');
                                                const div = document.createElement('div');
                                                div.className = 'form-group';
                                                div.innerHTML = `
                                                    <label>${key} <i class="fa-solid fa-xmark" style="font-size: 0.8em; color: red; cursor: pointer;" onclick="this.parentElement.parentElement.remove()"></i></label>
                                                    <input type="number" step="any" class="form-control measurement-input" data-field="${key}" value="${val}"
                                                           oninput="this.value = this.value.replace(/[^0-9.]/g, '')">
                                                `;
                                                container.appendChild(div);
                                            }
                                        }
                                    }
                                    // Pre-fill remarks
                                    if (data.remarks) {
                                        document.querySelector('textarea[name="remarks"]').value = data.remarks;
                                    }

                                    // Show nice message
                                    const msg = document.createElement('div');
                                    msg.className = 'alert alert-info';
                                    msg.textContent = 'Loaded previous measurement data. Please review.';
                                    msg.style.marginBottom = '1rem';
                                    msg.style.color = 'var(--primary-color)';
                                    msg.style.fontWeight = '500';
                                    document.getElementById('step2').insertBefore(msg, document.getElementById('measurementForm'));

                                }, 100);
                            }
                        });
                    }
                });
        }
    });
</script>

<!-- Order Details Modal -->
<div id="orderModal" class="sidebar-overlay" onclick="toggleOrderModal()">
    <div class="sidebar-panel" onclick="event.stopPropagation()">
        <div
            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem;">
            <h3 style="font-size: 1.5rem; font-weight: 600;">Order Details</h3>
            <button onclick="toggleOrderModal()"
                style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
        </div>

        <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Start Date (Today)</label>
            <input type="date" id="modal_start_date" class="form-control" readonly
                style="background-color: #f9fafb; cursor: not-allowed;">
        </div>

        <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Delivery / Finish Date</label>
            <input type="date" id="modal_delivery_date" class="form-control">
        </div>

        <hr style="margin: 1.5rem 0; border: 0; border-top: 1px solid var(--border-color);">
        <h4 style="margin-bottom: 1rem; font-weight: 600; color: var(--primary-color);">Payment Details</h4>

        <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Order Notes / Instructions</label>
            <textarea id="modal_order_notes" class="form-control" rows="2"
                placeholder="Specific splicing instructions, etc."></textarea>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Total Amount (₹)</label>
                <input type="number" id="modal_total_amt" class="form-control" placeholder="0.00" step="0.01">
            </div>
            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Advance Paid (₹)</label>
                <input type="number" id="modal_advance" class="form-control" placeholder="0.00" step="0.01">
            </div>
        </div>

        <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Payment Mode</label>
            <select id="modal_payment_mode" class="form-control">
                <option value="Cash">Cash</option>
                <option value="Online / UPI">Online / UPI</option>
                <option value="Card">Card</option>
                <option value="Bank Transfer">Bank Transfer</option>
            </select>
        </div>

        <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Bill Created By</label>
            <input type="text" id="modal_created_by" class="form-control" value="System" readonly
                style="background-color: #f9fafb; cursor: not-allowed;">
        </div>

        <!-- ... -->

        <!-- ... -->

        <!-- Auto-set Status to Processing (Hidden) -->
        <input type="hidden" id="modal_order_status" value="Processing">
        <div style="margin-bottom: 1rem; color: var(--primary-color); font-weight: 500;">
            Order Status: Processing (Auto)
        </div>

        <div style="margin-top: 2rem; border-top: 1px solid var(--border-color); padding-top: 1rem;">
            <button onclick="submitOrder()" class="btn btn-primary"
                style="width: 100%; justify-content: center; padding: 1rem; font-size: 1.1rem;">
                Confirm & Create Order
            </button>
        </div>
        <script>
            function toggleOrderModal() {
                const modal = document.getElementById('orderModal');
                if (!modal.classList.contains('active')) {
                    modal.style.display = 'flex';
                    setTimeout(() => { modal.classList.add('active'); }, 10);

                    // Set default dates
                    const today = new Date().toISOString().split('T')[0];

                    // Set Start Date to Today and Readonly
                    const startInput = document.getElementById('modal_start_date');
                    if (startInput) startInput.value = today;

                    // Set Delivery Date Min to Today
                    const deliveryInput = document.getElementById('modal_delivery_date');
                    if (deliveryInput) deliveryInput.min = today;

                } else {
                    modal.classList.remove('active');
                    setTimeout(() => { modal.style.display = 'none'; }, 300);
                }
            }
        </script>

        <style>
            .sidebar-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 1000;
                justify-content: flex-end;
            }

            .sidebar-panel {
                width: 100%;
                max-width: 450px;
                height: 100%;
                background: var(--card-bg);
                padding: 2rem;
                box-shadow: -4px 0 15px rgba(0, 0, 0, 0.1);
                transform: translateX(100%);
                transition: transform 0.3s ease-out;
                overflow-y: auto;
            }

            .sidebar-overlay.active .sidebar-panel {
                transform: translateX(0);
            }
        </style>
        {% endblock %}